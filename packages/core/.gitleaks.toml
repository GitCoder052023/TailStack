title = "Gitleaks Config"

# ---------------------------------------------------------------------------
# GLOBAL ALLOWLIST
# skips standard Node.js/React build artifacts and lockfiles.
# ---------------------------------------------------------------------------
[allowlist]
    description = "Global allowlist for Node/React artifacts"
    paths = [
        ".env.example", 
        "tsconfig.app.json", 
        "tsconfig.node.json",
        '''(?:^|/)node_modules(?:/|$)''',
        '''(?:^|/)build(?:/|$)''',
        '''(?:^|/)dist(?:/|$)''',
        '''(?:^|/)coverage(?:/|$)''',
        '''\.git''',
        '''package-lock\.json''',
        '''yarn\.lock''',
        '''pnpm-lock\.yaml''',
        '''__tests__/__snapshots__'''
    ]
    # Ignore lines specifically matching integrity hashes in lockfiles
    # just in case the path ignore fails or you scan a specific file.
    regexes = [
        '''integrity"\s*:\s*"sha(256|512)-''',
        '''const\s+[A-Z_]+_PUBLIC_KEY''',  # Allow explicitly named public keys
    ]

# ---------------------------------------------------------------------------
# RULES
# ---------------------------------------------------------------------------

# 1. AWS/Cloud Keys (The Essentials)
[[rules]]
    id = "aws-access-token"
    description = "AWS Access Key"
    regex = '''(A3T[A-Z0-9]|AKIA|AGPA|AIDA|AROA|AIPA|ANPA|ANVA|ASIA)[A-Z0-9]{16}'''
    tags = ["key", "aws"]

[[rules]]
    id = "aws-secret-key"
    description = "AWS Secret Key"
    regex = '''(?i)aws(.{0,20})?(?-i)['\"][0-9a-zA-Z\/+]{40}['\"]'''
    tags = ["key", "aws"]

# 2. Node/NPM Specifics
# Catches accidental publication of NPM tokens which compromise the supply chain.
[[rules]]
    id = "npm-access-token"
    description = "NPM Access Token"
    regex = '''npm_[a-z0-9]{36}'''
    tags = ["node", "npm"]

# 3. Database Connection Strings (Express Common)
# Catches standard Mongo and Postgres connection strings with passwords.
[[rules]]
    id = "db-connection-string"
    description = "Database Connection String (Mongo/Postgres)"
    regex = '''(?i)(mongodb(\+srv)?|postgresql|postgres):\/\/[^:]+:([^@/\s]+)@'''
    secretGroup = 3
    tags = ["db", "mongo", "postgres"]

# 4. Private Keys
# Catches any RSA/DSA private keys 
[[rules]]
    id = "private-key"
    description = "Generic Private Key"
    regex = '''-----BEGIN[ A-Z0-9_-]*PRIVATE KEY-----'''
    tags = ["crypto"]

# 5. The Generic Rule
# Catches variables named 'secret', 'key', 'token' assigned to high-entropy strings.
# This works for Stripe, SendGrid, Twilio, etc.
[[rules]]
    id = "generic-api-key"
    description = "Generic High-Entropy Secret Assignment"
    # Matches: const STRIPE_KEY = "sk_live_..." or apiKey: "12345..."
    # Looks for key words, an assignment operator, and a string of 8+ chars with mix of case/numbers.
    regex = '''(?i)((api|session|auth|access|refresh|secret)[_.-]?(key|token|secret|id)|password)\s*[:=]\s*['"]([a-zA-Z0-9\-_]{8,})['"]'''
    secretGroup = 4
    entropy = 3.5 # Helps reduce false positives on simple strings
    tags = ["generic"]